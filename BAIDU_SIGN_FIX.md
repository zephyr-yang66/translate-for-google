# 百度翻译签名问题修复说明

**日期**: 2025-11-10  
**问题**: 百度翻译API报错"签名方式不对"  
**状态**: ✅ 已修复并重新打包

---

## 📋 问题描述

用户在测试百度翻译连接时遇到"签名方式不对"的错误，根据 [百度翻译API官方文档](https://fanyi-api.baidu.com/doc/21) 检查发现潜在问题。

---

## 🔧 修复内容

### 1. 添加输入清理处理

**问题**: 用户在配置中可能不小心输入了多余的空格，导致签名计算错误。

**修复**:

```typescript
// 清理配置（去除空格）
const appId = config.appId?.trim() || '';
const secretKey = config.secretKey?.trim() || '';
```

### 2. 增强签名生成日志

**目的**: 帮助用户调试签名生成过程。

**修复**:

```typescript
console.log('[百度翻译] 签名生成详情:', {
  步骤1_拼接字符串: 'appid + q + salt + 密钥',
  步骤2_实际拼接: `${appId} + ${text.substring(0, 20)}... + ${salt} + ${secretKey.substring(0, 4)}...`,
  步骤3_签名字符串长度: signStr.length,
  步骤4_MD5签名: sign,
});
```

### 3. 改进错误提示

**修复前**:
```
'54001': '签名错误，请检查密钥是否正确'
```

**修复后**:
```
'54001': '签名错误！请检查：
1. APP ID 是否正确
2. 密钥是否正确
3. 配置中是否有多余的空格'
```

### 4. 添加详细错误日志

```typescript
console.error('[百度翻译] API错误详情:', {
  错误码: data.error_code,
  错误信息: errorMessage,
  完整响应: data,
});
```

### 5. 确认签名算法正确性

根据官方文档验证签名生成流程：

```
步骤1: 拼接字符串
string1 = appid + q + salt + 密钥

步骤2: MD5加密（UTF-8编码）
sign = MD5(string1)

步骤3: 生成32位小写MD5值
✓ 当前实现已正确
```

---

## 🎁 新增工具

### 百度翻译签名测试工具

创建了独立的测试页面 `baidu-sign-test.html`，用于：

- ✅ 验证签名生成是否正确
- ✅ 测试 APP ID 和密钥配置
- ✅ 直观显示签名生成过程
- ✅ 实时调用百度API进行验证

**使用方法**:

1. 在浏览器中打开 `baidu-sign-test.html`
2. 输入您的 APP ID 和密钥
3. 输入测试文本（如 "Hello world"）
4. 点击"生成签名并测试"
5. 查看签名生成过程和API调用结果

---

## 📊 打包结果

```
✓ background.js  33.08 kB │ gzip: 8.74 kB
✓ content.js     6.25 kB  │ gzip: 2.01 kB
✓ options.js     5.72 kB  │ gzip: 1.68 kB
✓ 已复制所有资源文件
```

---

## 🚀 使用指南

### 步骤 1: 重新加载扩展

1. 打开 `chrome://extensions/`
2. 找到「DeepSeek 翻译」扩展
3. 点击「刷新」按钮（🔄）
4. 确保扩展状态为「已启用」

### 步骤 2: 验证配置

1. 点击扩展图标，进入「设置」
2. 检查百度翻译配置：
   - ✅ APP ID 前后没有空格
   - ✅ 密钥前后没有空格
   - ✅ 没有多余的换行符
3. 点击「测试连接」按钮

### 步骤 3: 查看调试日志

如果仍然出现签名错误：

1. 打开 `chrome://extensions/`
2. 点击扩展的「service worker」链接
3. 查看控制台中的详细日志：
   - `[百度翻译] 签名生成详情` - 显示签名生成过程
   - `[百度翻译] API错误详情` - 显示错误信息
4. 截图发送日志以便进一步诊断

### 步骤 4: 使用独立测试工具（可选）

如果扩展中仍无法正常使用，可以使用独立测试工具验证配置：

1. 在浏览器中打开 `baidu-sign-test.html`
2. 输入相同的 APP ID 和密钥
3. 点击"生成签名并测试"
4. 如果测试成功，说明配置正确，问题可能在扩展其他部分
5. 如果测试失败，说明配置本身有问题，需要检查百度翻译控制台

---

## 📚 官方文档参考

- [百度翻译API - 通用翻译API接入文档](https://fanyi-api.baidu.com/doc/21)
- 签名生成规则: `appid + q + salt + 密钥` → MD5（UTF-8编码）

---

## ⚠️ 常见签名错误原因

| 错误原因 | 检查方法 | 解决方案 |
|---------|---------|---------|
| APP ID 错误 | 登录百度翻译控制台确认 | 重新复制正确的 APP ID |
| 密钥错误 | 登录百度翻译控制台确认 | 重新复制正确的密钥 |
| 配置中有空格 | 使用测试工具验证 | trim 处理已自动添加 |
| 字符编码问题 | 查看日志中的签名字符串长度 | MD5 实现已使用 UTF-8 |
| 参数顺序错误 | 查看签名生成详情日志 | 已按官方文档修正 |

---

## ✅ 验证清单

完成以下检查以确保问题已解决：

- [ ] 重新加载扩展（必须）
- [ ] 检查 APP ID 和密钥配置（去除空格）
- [ ] 点击「测试连接」按钮
- [ ] 查看浏览器控制台日志
- [ ] 如有必要，使用 `baidu-sign-test.html` 独立验证
- [ ] 在实际网页中测试翻译功能

---

## 🎯 技术要点

### 百度翻译API签名算法

```typescript
// 1. 拼接字符串
const signStr = appid + q + salt + secret;

// 2. MD5加密（UTF-8编码）
const sign = md5(signStr);

// 3. 发送请求
const url = `https://fanyi-api.baidu.com/api/trans/vip/translate?` +
  `q=${q}&from=en&to=zh&appid=${appid}&salt=${salt}&sign=${sign}`;
```

### 关键注意事项

1. **参数名称**: URL参数中必须使用 `appid`（全小写）
2. **字符编码**: 所有字符串必须使用 UTF-8 编码
3. **MD5格式**: 必须是32位小写的十六进制字符串
4. **随机数**: salt 可以使用时间戳或随机字符串
5. **参数顺序**: 严格按照 `appid + q + salt + secret` 的顺序

---

## 📝 修改文件列表

1. **src/api/baidu-translate.ts** - 主要修复文件
   - 添加配置清理（trim）
   - 增强签名生成日志
   - 改进错误提示
   - 添加详细错误日志

2. **baidu-sign-test.html** - 新增测试工具
   - 独立的签名测试页面
   - 可视化签名生成过程
   - 实时API调用验证

3. **dist/** - 重新打包的扩展文件
   - background.js (33.08 kB)
   - content.js (6.25 kB)
   - options.js (5.72 kB)

---

## 💡 下一步

如果问题仍然存在：

1. **确认API配置有效性**
   - 登录 [百度翻译开放平台](https://fanyi-api.baidu.com/)
   - 检查账户状态和余额
   - 确认 APP ID 和密钥是否正确

2. **使用测试工具验证**
   - 打开 `baidu-sign-test.html`
   - 输入配置并测试
   - 查看详细的签名生成过程

3. **提供调试信息**
   - 浏览器控制台截图
   - service worker 日志
   - 测试工具的结果截图

---

*修复日期: 2025-11-10*  
*文档作者: AI Assistant*


