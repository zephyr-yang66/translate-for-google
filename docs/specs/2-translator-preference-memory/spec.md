# 功能规范：翻译工具偏好记忆

**功能编号**：`2-translator-preference-memory`  
**创建时间**：2025-11-10  
**状态**：草稿  
**输入**：用户描述："1、配置页面选择配置的翻译工具作为默认选项，记录用户上一次使用的工具选项,下次默认使用用户上一次选择的工具。2、用户在切换翻译工具要调用户所选的工具API。如果此API缺少配置,引导用户去配置页面配置。3、配置页面用户点击保存设置,需要提示用户保存结果信息,如果缺少必要的配置提示用户去配置完成后保存"

## 澄清

### 会话 2025-11-10

- 问：用户可以在哪些位置切换翻译工具？ → 答：仅在翻译面板的下拉选择器切换（用户在使用翻译功能时直接选择工具）
- 问：什么时候应该调用翻译API？ → 答：有输入立即调用，没有输入不调用（切换工具时如果已有待翻译文本则立即用新工具翻译，无文本则只切换选择）
- 问：什么时候验证翻译工具的配置？ → 答：仅在有输入文本且切换工具要执行翻译时验证配置（无输入时切换不验证）
- 问：配置页面保存时应该验证哪些翻译工具的配置？ → 答：验证当前用户所选的翻译工具（只验证用户正在使用的那个工具是否配置完整）
- 问：首次使用插件时，如何确定默认翻译工具？ → 答：始终默认为LibreTranslate（无需配置，用户可立即使用）

## 用户场景和测试

### 用户故事 1 - 记住上次使用的翻译工具（优先级：P1）

用户在翻译面板的下拉选择器中选择了某个翻译工具（如百度翻译、DeepSeek或LibreTranslate），系统自动记住这个选择，下次打开翻译面板时自动选中上次使用的工具，无需重复选择。

**为什么是这个优先级**：这是核心用户体验功能，直接影响用户的使用效率。用户不应该每次都重复选择同样的工具，这会造成不必要的操作负担。这是最小可行产品（MVP）的基础功能。

**独立测试**：可以通过在翻译面板选择翻译工具、关闭浏览器、重新打开来完全测试，验证偏好是否被保存并自动恢复。

**验收场景**：

1. **假设** 用户首次使用插件且未配置任何偏好，**当** 用户打开翻译面板，**那么** 下拉选择器默认选中"LibreTranslate"
2. **假设** 用户首次使用插件，**当** 用户在翻译面板下拉选择器中选择"百度翻译"并使用，**那么** 系统记住这个选择，下次打开时默认选中"百度翻译"
3. **假设** 用户上次在翻译面板使用了"DeepSeek"翻译，**当** 用户关闭浏览器后重新打开翻译面板，**那么** 下拉选择器自动选中"DeepSeek"
4. **假设** 用户使用"百度翻译"完成了一次翻译，**当** 用户在同一会话中再次打开翻译面板，**那么** 下拉选择器仍然选中"百度翻译"
5. **假设** 用户在翻译面板从"LibreTranslate"切换到"DeepSeek"（无论是否有输入文本），**当** 用户关闭并重新打开翻译面板，**那么** 下拉选择器自动选中"DeepSeek"而非"LibreTranslate"
6. **假设** 用户已输入文本"Hello"并选择了"百度翻译"，**当** 用户切换到"DeepSeek"，**那么** 系统立即使用DeepSeek重新翻译"Hello"并显示结果
7. **假设** 用户未输入任何文本，**当** 用户从"百度翻译"切换到"DeepSeek"，**那么** 只切换下拉选择器，不触发任何翻译API调用

---

### 用户故事 2 - 配置验证与引导（优先级：P1）

用户在翻译面板的下拉选择器中切换到某个翻译工具时，如果该工具缺少必要的配置（如API密钥），系统自动检测并引导用户前往配置页面完成配置，确保用户能够顺利使用所选工具。

**为什么是这个优先级**：这是必不可少的功能，防止用户因配置缺失而无法使用翻译功能。良好的错误处理和用户引导是基本的用户体验要求，应该在MVP中包含。

**独立测试**：可以通过清除某个翻译工具的配置、在翻译面板尝试切换到该工具来独立测试，验证是否正确提示并引导配置。

**验收场景**：

1. **假设** 用户已输入文本"Hello"并在翻译面板下拉选择器切换到未配置的"百度翻译"，**当** 系统尝试翻译，**那么** 在翻译面板显示友好的提示信息，说明需要配置百度翻译API，并提供"前往配置"按钮
2. **假设** 用户未输入任何文本，**当** 用户在翻译面板切换到未配置的"百度翻译"，**那么** 下拉选择器切换成功，不显示配置提示（因为没有触发翻译）
3. **假设** 用户看到配置缺失提示，**当** 用户点击"前往配置"按钮，**那么** 自动打开配置页面并定位到对应的翻译工具配置区域
4. **假设** 用户已正确配置"DeepSeek"并输入文本"你好"，**当** 用户在翻译面板切换到"DeepSeek"，**那么** 系统立即使用DeepSeek翻译文本，不显示配置提示
5. **假设** 用户有多个翻译工具未配置并已输入待翻译文本，**当** 用户在翻译面板切换到其中任何一个，**那么** 提示信息中明确指出是哪个工具需要配置
6. **假设** 用户在翻译面板下拉选择器中选择了未配置的"百度翻译"，**当** 配置提示显示时，**那么** 下拉选择器保持在"百度翻译"，不自动回退到之前的工具

---

### 用户故事 3 - 配置保存验证与反馈（优先级：P2）

用户在配置页面修改设置后点击保存，系统验证当前所选翻译工具的配置完整性，提供清晰的保存结果反馈，如果当前工具配置不完整则提示用户补充必要信息。

**为什么是这个优先级**：虽然重要，但这是对现有配置功能的增强。用户可以先配置好再使用，即使没有实时验证反馈，只要在使用时能检测到配置问题（用户故事2），也能勉强工作。因此优先级略低于前两个故事。

**独立测试**：可以通过在配置页面填写部分配置、点击保存来独立测试，验证验证逻辑和反馈信息是否正确。

**验收场景**：

1. **假设** 用户当前选择的是"百度翻译"并在配置页面正确填写了所有必填项（APP ID和Secret Key），**当** 用户点击"保存设置"按钮，**那么** 显示"配置保存成功"的提示消息
2. **假设** 用户当前选择的是"百度翻译"但只填写了APP ID未填写Secret Key，**当** 用户点击"保存设置"按钮，**那么** 显示提示信息"百度翻译配置不完整：缺少Secret Key"，配置不被保存
3. **假设** 用户当前选择的是"DeepSeek"但未填写API Key，**当** 用户点击"保存设置"，**那么** 显示提示"DeepSeek配置不完整：缺少API Key，请完成配置后保存"
4. **假设** 用户当前选择的是"LibreTranslate"（无需必填配置），**当** 用户点击"保存设置"，**那么** 直接保存成功并显示成功消息
5. **假设** 用户当前选择的是"百度翻译"且配置完整，但DeepSeek配置不完整，**当** 用户点击"保存设置"，**那么** 保存成功（只验证当前所选的百度翻译），不提示DeepSeek的配置问题
6. **假设** 用户在配置页面修改了配置后点击保存成功，**当** 保存成功后，**那么** 显示成功消息并自动关闭提示（3秒后）或允许用户手动关闭

---

### 边缘情况

- **当用户从未选择过翻译工具时会发生什么？**
  - 系统默认使用LibreTranslate（免费且无需配置）
  - 用户可以立即开始使用翻译功能，无需先进行配置

- **当用户上次使用的翻译工具的配置被删除后会发生什么？**
  - 系统应检测到配置缺失，显示配置引导提示
  - 同时尝试切换到其他已配置的工具，或提示用户选择另一个工具

- **当用户同时配置了多个翻译工具时的优先级是什么？**
  - 优先使用用户上次选择的工具
  - 如果上次选择的工具不可用，则按照预设优先级选择（LibreTranslate > 其他已配置工具）

- **当浏览器存储空间不足或被清除时会发生什么？**
  - 系统应优雅降级，恢复到默认配置
  - 不应该因为无法读取存储而导致功能不可用

- **当用户在多个浏览器或设备上使用插件时？**
  - 每个浏览器/设备独立维护偏好设置（基于浏览器本地存储）
  - 未来可以考虑云同步功能，但不在当前需求范围内

- **当配置页面保存时网络断开或保存失败时？**
  - 显示明确的错误提示："保存失败，请检查网络连接后重试"
  - 不清除用户已填写的配置数据，允许用户重试

## 需求

### 功能需求

- **FR-001**：翻译面板必须提供下拉选择器让用户选择翻译工具
- **FR-002**：下拉选择器必须显示所有可用的翻译工具（百度翻译、DeepSeek、LibreTranslate）
- **FR-003**：系统必须持久化存储用户上次在翻译面板选择的翻译工具标识符
- **FR-004**：系统必须在每次用户通过下拉选择器切换翻译工具时自动更新存储的工具偏好
- **FR-005**：系统必须在用户打开翻译面板时自动读取并应用上次使用的翻译工具到下拉选择器
- **FR-006**：系统必须在用户通过下拉选择器切换翻译工具时，如果已有待翻译文本则立即调用对应工具的API执行翻译，如果无输入文本则仅切换选择不调用API
- **FR-007**：系统必须在有输入文本且用户切换翻译工具要执行翻译时验证目标工具的配置完整性，无输入文本时切换不验证
- **FR-008**：系统必须在检测到配置缺失时在翻译面板显示清晰的提示信息，说明缺少哪些配置项
- **FR-009**：系统必须提供快捷方式（按钮或链接）让用户从翻译面板的配置提示直接跳转到配置页面
- **FR-010**：配置页面必须在用户点击"保存设置"时验证当前用户所选翻译工具的配置完整性
- **FR-011**：配置页面必须在保存成功后显示成功反馈消息
- **FR-012**：配置页面必须在当前所选工具配置不完整时显示具体的错误信息，指出缺少哪些配置项
- **FR-013**：配置页面必须在发现当前所选工具配置不完整时阻止保存操作，保持用户在配置页面
- **FR-014**：系统必须在首次使用且无偏好记录时默认使用LibreTranslate翻译工具
- **FR-015**：系统必须在用户上次选择的工具配置被删除时，显示配置提示或自动回退到LibreTranslate

### 关键实体

- **翻译工具偏好**：记录用户上次使用的翻译工具
  - 属性：工具标识符（如 'baidu'、'deepseek'、'libretranslate'）
  - 存储位置：浏览器本地存储（chrome.storage.local或localStorage）
  - 生命周期：持久化，直到用户清除浏览器数据

- **翻译工具配置**：每个翻译工具的配置信息
  - 属性：API密钥、Secret Key、服务器地址等
  - 完整性状态：已配置/未配置/部分配置
  - 与翻译工具偏好的关系：偏好指向的工具必须是已配置状态才能正常使用

- **配置验证结果**：验证翻译工具配置的结果
  - 属性：是否有效、缺失的配置项列表、错误消息
  - 用途：决定是否允许使用工具或保存配置

## 成功标准

### 可衡量的结果

- **SC-001**：用户在选择翻译工具后，下次打开插件时无需重新选择，工具偏好准确恢复率达到100%
- **SC-002**：当用户尝试使用未配置的翻译工具时，在500毫秒内显示配置提示，100%的情况下提供配置引导
- **SC-003**：配置页面的保存验证在200毫秒内完成，并在1秒内向用户显示明确的结果反馈（成功或失败原因）
- **SC-004**：用户从配置提示跳转到配置页面的操作在3次点击内完成（理想情况1次点击）
- **SC-005**：减少因配置问题导致的翻译失败率至少80%（通过提前验证和引导）
- **SC-006**：配置错误信息的准确性达到100%，用户能根据提示信息准确找到并修复配置问题

## 假设

1. **存储可用性**：假设浏览器的chrome.storage.local或localStorage功能正常可用，容量足够存储用户配置（预计<100KB）
2. **翻译工具标识符稳定**：假设翻译工具的标识符（'baidu'、'deepseek'等）在系统中是固定的，不会动态变化
3. **配置项已知**：假设每个翻译工具的必填配置项是已知且明确的（例如百度翻译需要APP ID和Secret Key）
4. **单用户环境**：假设插件在单用户环境下使用，不涉及多用户权限或配置隔离
5. **即时生效**：假设配置保存后立即生效，无需重启浏览器或重新加载插件
6. **默认工具选择**：LibreTranslate作为免费且无需配置的工具，是首次使用时的默认选择
7. **配置页面可访问**：假设配置页面可以通过chrome.runtime.openOptionsPage()或类似API直接打开

## 依赖项

- 现有的翻译工具API集成（百度翻译、DeepSeek、LibreTranslate）
- 现有的配置存储机制（config.ts）
- Chrome扩展的存储API（chrome.storage）
- 翻译工具管理器（translation-manager.ts）

## 范围限制

**包含在范围内**：
- 翻译面板的下拉选择器用于切换翻译工具
- 记住用户上次在翻译面板选择的翻译工具
- 切换工具时立即调用对应API
- 切换工具时的配置验证
- 配置缺失时的用户引导
- 配置保存时的完整性验证和反馈

**不包含在范围内**：
- 在配置页面切换默认翻译工具（切换仅在翻译面板进行）
- 多设备间的配置同步
- 翻译工具的启用/禁用管理
- 翻译工具的添加/删除功能
- 配置的导入/导出功能
- 配置的版本管理或回滚
- 翻译工具的性能监控或推荐

