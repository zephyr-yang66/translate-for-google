# 修复验证指南

本文档说明如何验证"发送消息失败"错误的修复效果。

## 修复内容

已修复插件在安装/更新后无法向已打开页面发送消息的问题，现在会显示友好的错误提示。

### 主要改进

1. **智能错误检测**：自动识别不同类型的连接失败原因
2. **友好错误提示**：使用系统通知或 Badge 提示用户如何解决问题
3. **特殊页面处理**：识别浏览器内置页面并给出明确提示

## 测试场景

### 场景 1：插件刚安装/更新后（最常见）

**测试步骤：**
1. 打开一个普通网页（如百度、知乎等）
2. 在 Chrome 扩展管理页面重新加载插件（或刚安装插件）
3. 在该网页选中一段英文文本
4. 右键点击 "使用 DeepSeek 翻译"

**预期结果：**
- 显示通知："需要刷新页面 - 请刷新当前页面后再使用翻译功能。这通常发生在插件刚安装或更新后。"
- 或在插件图标上显示红色感叹号 Badge（3秒后消失）

**解决方法：**
- 刷新页面后即可正常使用

---

### 场景 2：在浏览器内置页面使用

**测试步骤：**
1. 打开以下任意页面：
   - Chrome 新标签页（chrome://newtab）
   - Chrome 设置页（chrome://settings）
   - Chrome 扩展管理（chrome://extensions）
   - Chrome 历史记录（chrome://history）
2. 选中页面中的文本
3. 右键点击 "使用 DeepSeek 翻译"

**预期结果：**
- 显示通知："不支持的页面 - 浏览器内置页面（如设置页、新标签页等）不支持翻译功能，请在普通网页上使用"

---

### 场景 3：正常使用（已刷新的页面）

**测试步骤：**
1. 打开任意普通网页
2. 确保页面已完全加载
3. 选中一段英文文本
4. 右键点击 "使用 DeepSeek 翻译"

**预期结果：**
- 右侧弹出翻译抽屉
- 显示原文和译文
- 无任何错误提示

---

### 场景 4：权限不足的页面

**测试步骤：**
1. 打开一些可能有内容安全策略限制的页面
2. 选中文本并尝试翻译

**预期结果：**
- 显示通知："权限不足 - 当前页面不允许使用此功能，请在其他页面尝试"

---

## 验证清单

完成以下测试项目，确认修复有效：

- [ ] **场景 1**：插件刚安装/更新后，在已打开的页面使用，显示"需要刷新页面"提示
- [ ] **场景 2**：在 chrome:// 页面使用，显示"不支持的页面"提示
- [ ] **场景 3**：在刷新后的普通网页使用，翻译功能正常工作
- [ ] **场景 4**：通知显示正常（或 Badge 显示正常）
- [ ] **场景 5**：刷新页面后，翻译功能完全正常

## 技术细节

### 修改的文件

1. **src/background.ts**
   - 添加 `isRestrictedUrl()` 函数检测特殊页面
   - 添加 `showErrorNotification()` 函数显示友好提示
   - 改进消息发送错误处理逻辑

2. **public/manifest.json** 和 **dist/manifest.json**
   - 添加 `notifications` 权限

### 错误类型识别

代码会识别以下错误类型并给出对应提示：

| 错误信息 | 原因 | 用户提示 |
|---------|------|---------|
| "Receiving end does not exist" | Content script 未注入 | "需要刷新页面" |
| "Cannot access" | 权限不足 | "权限不足" |
| 特殊 URL (chrome://) | 内置页面 | "不支持的页面" |
| 其他错误 | 未知原因 | "翻译失败，请刷新页面后重试" |

## 常见问题

### Q: 为什么插件刚安装时需要刷新页面？

**A:** Chrome 扩展的 content script 只会在页面加载时注入。如果插件是在页面已经打开后才安装的，那个页面就没有注入 content script，自然无法接收消息。刷新页面后，content script 会正常注入。

### Q: 通知没有显示怎么办？

**A:** 如果通知权限被禁用或创建失败，插件会降级使用 Badge（在插件图标上显示红色感叹号）作为提示。

### Q: 如何快速测试修复效果？

**A:** 最简单的方法是在扩展管理页面点击插件的"重新加载"按钮，然后在一个已打开的网页上尝试翻译，应该会看到"需要刷新页面"的提示。

## 成功标准

修复成功的标志：
✅ 不再看到控制台中的红色错误信息
✅ 用户能看到清晰的提示信息
✅ 用户知道如何解决问题（刷新页面）
✅ 在浏览器内置页面能正确提示不支持

## 下一步

如果所有测试通过，插件已成功修复。用户现在会得到友好的错误提示，而不是神秘的控制台错误信息。

