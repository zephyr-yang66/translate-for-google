---
level: 10
description: å…¬å¸çº§é€šç”¨ Common Admin ä¸­åå°é¡µé¢å¼€å‘ï¼Œ API è°ƒç”¨ä¸å¤„ç†è§„èŒƒã€‚
globs: **/*.{ts,js}
---

# API è°ƒç”¨ä¸é”™è¯¯å¤„ç†è§„èŒƒ

> é¡¹ç›® `@/utils/common/request.ts` è¿”å› `[error, data]` å…ƒç»„æ ¼å¼,å…¨å±€å·²å¤„ç†é”™è¯¯æç¤º

## ğŸ¯ æ ¸å¿ƒè§„åˆ™

```yaml
è¿”å›æ ¼å¼: [error, data] å…ƒç»„(é”™è¯¯ä¼˜å…ˆ)
å…¨å±€å¤„ç†: HTTPé”™è¯¯ã€ä¸šåŠ¡é”™è¯¯ã€Tokenè¿‡æœŸå·²è‡ªåŠ¨å¼¹å‡ºæç¤º
ç»„ä»¶è§„èŒƒ:
  - æ€»æ˜¯ä½¿ç”¨: const [error, data] = await apiCall()
  - æ€»æ˜¯æ£€æŸ¥: if (error) return
  - ä¸è¦é‡å¤æç¤ºé”™è¯¯(å…¨å±€å·²å¤„ç†)
  - data æ˜¯å®é™…æ•°æ®,ä¸éœ€è¦ data.data
```

## ç±»å‹å®šä¹‰

```typescript
// è¿”å›ç±»å‹
type IResponseArr<T> = [IErrorInfo | undefined, T | undefined];

// é”™è¯¯ç»“æ„
interface IErrorInfo {
  code: string;
  message: string;
  subCode?: string;  // ç‰¹æ®Šé”™è¯¯ç ,å¦‚ 'auth-check-error'
}

// å“åº”ç»“æ„
interface IResponseData<T> {
  code: string;      // '10000' = æˆåŠŸ
  msg: string;
  subMsg?: string;
  subCode?: string;
  data: T;
}
```

## æ ‡å‡†æ¨¡æ¿(å¿…é¡»éµå¾ª)

```typescript
// åˆ—è¡¨æŸ¥è¯¢
const loadData = async () => {
  loading.value = true;
  const [error, data] = await getUserList(params);
  loading.value = false;

  if (error) return;  // é”™è¯¯å·²å…¨å±€æç¤º

  userList.value = data.list;
  pagination.total = data.total;
};

// åˆ›å»º/æ›´æ–°
const handleSubmit = async () => {
  try {
    await formRef.value?.validate();
  } catch (error) {
    return;
  }

  submitLoading.value = true;
  const [error, data] = await createUser(formData);
  submitLoading.value = false;

  if (error) return;  // é”™è¯¯å·²å…¨å±€æç¤º

  message.success('åˆ›å»ºæˆåŠŸ');
  router.back();
};

// åˆ é™¤
const handleDelete = async (record: UserInfo) => {
  const [error, data] = await deleteUser(record.id);
  if (error) return;

  message.success('åˆ é™¤æˆåŠŸ');
  loadData();
};

// è¯¦æƒ…åŠ è½½
const loadDetail = async () => {
  if (!userId.value) return;

  loading.value = true;
  const [error, data] = await getUserDetail(userId.value);
  loading.value = false;

  if (error) {
    router.back();  // å¯é€‰:é”™è¯¯æ—¶è¿”å›åˆ—è¡¨é¡µ
    return;
  }

  userInfo.value = data;
};
```

## ç‰¹æ®Šåœºæ™¯

```typescript
// åœºæ™¯1: æ ¹æ®é”™è¯¯ç è‡ªå®šä¹‰å¤„ç†
const [error, response] = await updateConfig(data);

if (error?.subCode === 'CONFIG_CONFLICT') {
  showConflictModal(error.message);
  return;
}

if (error) return;  // å…¶ä»–é”™è¯¯å·²å…¨å±€å¤„ç†

// åœºæ™¯2: åŒæ—¶æ£€æŸ¥errorå’Œresponse.success
const [error, response] = await submitForm(formData);

if (!error && response?.success) {
  message.success('æäº¤æˆåŠŸ');
  emit('success');
} else {
  formRef.value?.resetFields();  // å¤±è´¥æ—¶é‡ç½®è¡¨å•
}

// åœºæ™¯3: æ‰‹åŠ¨æå–é”™è¯¯ä¿¡æ¯(ä¼˜å…ˆçº§)
const errorMsg = error?.message || response?.subMsg || response?.msg || 'æ“ä½œå¤±è´¥';
```

## å¸¸è§é”™è¯¯

```typescript
// é”™è¯¯1: ä¸ä½¿ç”¨è§£æ„
const response = await getUserList(params);
if (response.success) { ... }

// é”™è¯¯2: å¿˜è®°æ£€æŸ¥error
const [error, data] = await getUserList(params);
userList.value = data.list;  // dataå¯èƒ½æ˜¯undefined

// é”™è¯¯3: é‡å¤æç¤º
const [error, data] = await createUser(formData);
if (error) {
  message.error(error.message);
  return;
}

// é”™è¯¯4: è®¿é—®data.data
userList.value = data.data.list;

// é”™è¯¯5: loadingæœªå…³é—­
loading.value = true;
const [error, data] = await getUserList(params);
if (error) return;
loading.value = false;
```

## API å®šä¹‰è§„èŒƒ

```typescript
// api/user.ts
import { request } from '@/utils/common/request';

export const getUserList = (params: UserListParams) => {
  return request<PageData<UserInfo>>({
    url: '/api/user/list',
    method: 'get',
    params,
  });
};

export const createUser = (data: UserFormData) => {
  return request({
    url: '/api/user',
    method: 'post',
    data,
  });
};

export const updateUser = (id: number, data: UserFormData) => {
  return request({
    url: `/api/user/${id}`,
    method: 'put',
    data,
  });
};

export const deleteUser = (id: number) => {
  return request({
    url: `/api/user/${id}`,
    method: 'delete',
  });
};
```

## æ£€æŸ¥æ¸…å•

```yaml
æ¯æ¬¡APIè°ƒç”¨å¿…é¡»åŒ…å«:
  loadingçŠ¶æ€ç®¡ç†(å¼€å§‹/ç»“æŸ)
  é”™è¯¯æ£€æŸ¥(if (error) return)
  æˆåŠŸæç¤º(message.success)
  æ•°æ®ä½¿ç”¨(data,ä¸æ˜¯data.data)

ç‰¹åˆ«æ³¨æ„:
  - Tokenè¿‡æœŸ: å…¨å±€å·²å¤„ç†,ç»„ä»¶åªéœ€return
  - ä¸šåŠ¡é”™è¯¯: å…¨å±€å·²æç¤º,ç»„ä»¶åªéœ€return
  - ç½‘ç»œé”™è¯¯: å…¨å±€å·²æç¤º,ç»„ä»¶åªéœ€return
  - Loadingå…³é—­: æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¦å…³é—­
```
